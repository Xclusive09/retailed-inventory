<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/assets/css/styles.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
<div class="flex h-screen">
    <div id="sidebar"></div>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-sm">
            <div class="px-4 sm:px-6 py-4 flex items-center justify-between">
                <div class="flex items-center">
                    <button id="mobile-menu-btn" class="lg:hidden text-gray-500 hover:text-gray-700 mr-4">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <h2 class="text-xl font-semibold text-gray-800">Purchase Management</h2>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="new-purchase-btn" class="btn-animate bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
                        <i class="fas fa-plus mr-2"></i>
                        <span class="hidden sm:inline">New Purchase</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 sm:p-6">
            <!-- Purchase Stats -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-sm p-4 hover-card">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-shopping-cart text-blue-600"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-500">Total Purchases</div>
                            <div class="text-lg font-semibold text-gray-900" id="total-purchases">0</div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-4 hover-card">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-dollar-sign text-green-600"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-500">Total Spent</div>
                            <div class="text-lg font-semibold text-gray-900" id="total-spent">₦0</div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-4 hover-card">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-clock text-orange-600"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-500">Pending Orders</div>
                            <div class="text-lg font-semibold text-gray-900" id="pending-orders">0</div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-4 hover-card">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-truck text-purple-600"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-500">Suppliers</div>
                            <div class="text-lg font-semibold text-gray-900" id="suppliers-count">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Purchase Form -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6 hidden" id="purchase-form-section">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-plus text-blue-600 mr-2"></i>Record New Purchase
                    </h3>
                    <button id="close-purchase-form" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="purchase-form" class="space-y-6">
                    <!-- Purchase Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="item-select" class="block text-sm font-medium text-gray-700 mb-2">Select Item *</label>
                            <select id="item-select" required class="form-input">
                                <option value="">Choose an item...</option>
                            </select>
                        </div>
                        <div>
                            <label for="supplier-name" class="block text-sm font-medium text-gray-700 mb-2">Supplier</label>
                            <input type="text" id="supplier-name" class="form-input" placeholder="Enter supplier name">
                        </div>
                        <div>
                            <label for="invoice-number" class="block text-sm font-medium text-gray-700 mb-2">Invoice Number</label>
                            <input type="text" id="invoice-number" class="form-input" placeholder="Auto-generated">
                        </div>
                        <div>
                            <label for="purchase-quantity" class="block text-sm font-medium text-gray-700 mb-2">Quantity *</label>
                            <input type="number" id="purchase-quantity" required min="1" class="form-input">
                        </div>
                        <div>
                            <label for="unit-price" class="block text-sm font-medium text-gray-700 mb-2">Unit Price (₦) *</label>
                            <input type="number" id="unit-price" required min="0" step="0.01" class="form-input">
                        </div>
                        <div>
                            <label for="delivery-date" class="block text-sm font-medium text-gray-700 mb-2">Expected Delivery</label>
                            <input type="date" id="delivery-date" class="form-input">
                        </div>
                    </div>

                    <!-- Purchase Summary -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-medium text-gray-900 mb-3">Purchase Summary</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Quantity:</span>
                                <span id="summary-quantity" class="font-medium">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Unit Price:</span>
                                <span id="summary-unit-price" class="font-medium">₦0</span>
                            </div>
                            <hr class="border-gray-300">
                            <div class="flex justify-between text-lg font-semibold">
                                <span>Total Cost:</span>
                                <span id="total-cost" class="text-blue-600">₦0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label for="purchase-notes" class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                        <textarea id="purchase-notes" rows="3" class="form-input" placeholder="Add any notes about this purchase..."></textarea>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-purchase" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" class="btn-animate bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                            <i class="fas fa-save mr-2"></i>Record Purchase
                        </button>
                    </div>
                </form>
            </div>

            <!-- Purchase History -->
            <div class="bg-white rounded-lg shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Purchase History</h3>
                    <div class="flex items-center space-x-4">
                        <select id="status-filter" class="form-input text-sm">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <input type="date" id="date-filter" class="form-input text-sm">
                        <button id="export-purchases" class="text-gray-600 hover:text-gray-800 px-3 py-2 border rounded-lg text-sm">
                            <i class="fas fa-download mr-1"></i>Export
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purchase Details</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                        </thead>
                        <tbody id="purchases-list" class="bg-white divide-y divide-gray-200">
                        <!-- Purchases will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div id="purchases-loading" class="flex items-center justify-center py-12">
                    <div class="loading-spinner mr-3"></div>
                    <span class="text-gray-500">Loading purchases...</span>
                </div>

                <!-- Empty State -->
                <div id="purchases-empty" class="hidden text-center py-12">
                    <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-truck text-gray-400 text-3xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No purchases found</h3>
                    <p class="text-gray-500 mb-4">Start by recording your first purchase order.</p>
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>Record First Purchase
                    </button>
                </div>
            </div>
        </main>
    </div>
</div>

<script type="module">
    import { insertSidebar } from '../components/sidebar.js';
    import { getAllItems } from '../assets/js/inventory.js';
    import { getAllPurchases, addPurchase } from '../assets/js/purchase.js';
    import { initializeMockData } from '../assets/data/mock-data.js';

    document.addEventListener('DOMContentLoaded', async () => {
        // Initialize
        initializeMockData();
        document.getElementById('sidebar').innerHTML = insertSidebar('purchase');

        await initializePurchasePage();
    });

    async function initializePurchasePage() {
        const elements = {
            newPurchaseBtn: document.getElementById('new-purchase-btn'),
            purchaseFormSection: document.getElementById('purchase-form-section'),
            closePurchaseForm: document.getElementById('close-purchase-form'),
            cancelPurchase: document.getElementById('cancel-purchase'),
            purchaseForm: document.getElementById('purchase-form'),
            itemSelect: document.getElementById('item-select'),
            supplierName: document.getElementById('supplier-name'),
            invoiceNumber: document.getElementById('invoice-number'),
            purchaseQuantity: document.getElementById('purchase-quantity'),
            unitPrice: document.getElementById('unit-price'),
            deliveryDate: document.getElementById('delivery-date'),
            purchasesList: document.getElementById('purchases-list'),
            purchasesLoading: document.getElementById('purchases-loading'),
            purchasesEmpty: document.getElementById('purchases-empty'),
            statusFilter: document.getElementById('status-filter'),
            dateFilter: document.getElementById('date-filter')
        };

        let availableItems = [];
        let allPurchases = [];

        // Load data
        async function loadData() {
            elements.purchasesLoading.classList.remove('hidden');
            elements.purchasesEmpty.classList.add('hidden');

            await new Promise(resolve => setTimeout(resolve, 500));

            availableItems = getAllItems();
            allPurchases = getAllPurchases();

            elements.purchasesLoading.classList.add('hidden');
            populateItemSelect();
            renderPurchases(allPurchases);
            updateStats(allPurchases);
        }

        function populateItemSelect() {
            elements.itemSelect.innerHTML = '<option value="">Choose an item...</option>' +
                availableItems.map(item =>
                    `<option value="${item.id}" data-supplier="${item.supplier || ''}">${item.name}</option>`
                ).join('');
        }

        function updateStats(purchases) {
            const totalPurchases = purchases.length;
            const totalSpent = purchases.reduce((sum, purchase) => sum + purchase.total, 0);
            const pendingOrders = purchases.filter(p => p.status === 'pending').length;
            const suppliers = new Set(purchases.map(p => p.supplier)).size;

            document.getElementById('total-purchases').textContent = totalPurchases;
            document.getElementById('total-spent').textContent = `₦${totalSpent.toLocaleString()}`;
            document.getElementById('pending-orders').textContent = pendingOrders;
            document.getElementById('suppliers-count').textContent = suppliers;
        }

        function renderPurchases(purchases) {
            if (purchases.length === 0) {
                elements.purchasesList.innerHTML = '';
                elements.purchasesEmpty.classList.remove('hidden');
                return;
            }

            elements.purchasesEmpty.classList.add('hidden');
            elements.purchasesList.innerHTML = purchases.map(purchase => {
                const statusConfig = {
                    'pending': { class: 'status-badge warning', icon: 'clock', text: 'Pending' },
                    'delivered': { class: 'status-badge success', icon: 'check-circle', text: 'Delivered' },
                    'cancelled': { class: 'status-badge danger', icon: 'times-circle', text: 'Cancelled' }
                };
                const status = statusConfig[purchase.status] || statusConfig['pending'];

                return `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10">
                                        <div class="h-10 w-10 rounded-lg bg-blue-100 flex items-center justify-center">
                                            <i class="fas fa-box text-blue-600"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">${purchase.itemName}</div>
                                        <div class="text-sm text-gray-500">
                                            ${new Date(purchase.date).toLocaleDateString()}
                                            ${purchase.invoiceNumber ? `• ${purchase.invoiceNumber}` : ''}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${purchase.supplier}</div>
                                ${purchase.deliveryDate ? `<div class="text-sm text-gray-500">Expected: ${new Date(purchase.deliveryDate).toLocaleDateString()}</div>` : ''}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${purchase.quantity}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ₦${purchase.unitPrice.toLocaleString()}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                ₦${purchase.total.toLocaleString()}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="${status.class}">
                                    <i class="fas fa-${status.icon} mr-1"></i>
                                    ${status.text}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex items-center space-x-2">
                                    <button onclick="viewPurchaseDetails(${purchase.id})" class="text-blue-600 hover:text-blue-900" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${purchase.status === 'pending' ? `
                                        <button onclick="markAsDelivered(${purchase.id})" class="text-green-600 hover:text-green-900" title="Mark as Delivered">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button onclick="cancelPurchase(${purchase.id})" class="text-red-600 hover:text-red-900" title="Cancel">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : ''}
                                    <button onclick="printPurchaseOrder(${purchase.id})" class="text-gray-600 hover:text-gray-900" title="Print">
                                        <i class="fas fa-print"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
            }).join('');
        }

        function generateInvoiceNumber() {
            return 'PUR' + Date.now().toString().slice(-6);
        }

        function updatePurchaseSummary() {
            const quantity = parseInt(elements.purchaseQuantity.value) || 0;
            const unitPrice = parseFloat(elements.unitPrice.value) || 0;
            const total = quantity * unitPrice;

            document.getElementById('summary-quantity').textContent = quantity;
            document.getElementById('summary-unit-price').textContent = `₦${unitPrice.toLocaleString()}`;
            document.getElementById('total-cost').textContent = `₦${total.toLocaleString()}`;
        }

        // Event Listeners
        elements.newPurchaseBtn.addEventListener('click', () => {
            elements.purchaseFormSection.classList.remove('hidden');
            elements.invoiceNumber.value = generateInvoiceNumber();

            // Set default delivery date (7 days from now)
            const futureDate = new Date();
            futureDate.setDate(futureDate.getDate() + 7);
            elements.deliveryDate.value = futureDate.toISOString().split('T')[0];
        });

        [elements.closePurchaseForm, elements.cancelPurchase].forEach(btn => {
            btn?.addEventListener('click', () => {
                elements.purchaseFormSection.classList.add('hidden');
                elements.purchaseForm.reset();
            });
        });

        elements.itemSelect.addEventListener('change', (e) => {
            const selectedOption = e.target.selectedOptions[0];
            if (selectedOption && selectedOption.dataset.supplier) {
                elements.supplierName.value = selectedOption.dataset.supplier;
            }
        });

        [elements.purchaseQuantity, elements.unitPrice].forEach(input => {
            input.addEventListener('input', updatePurchaseSummary);
        });

        elements.purchaseForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const purchaseData = {
                itemId: parseInt(elements.itemSelect.value),
                quantity: parseInt(elements.purchaseQuantity.value),
                unitPrice: parseFloat(elements.unitPrice.value),
                supplier: elements.supplierName.value || 'Unknown Supplier',
                invoiceNumber: elements.invoiceNumber.value,
                deliveryDate: elements.deliveryDate.value ? new Date(elements.deliveryDate.value).toISOString() : null,
                notes: document.getElementById('purchase-notes').value,
                status: 'pending'
            };

            try {
                await addPurchase(purchaseData.itemId, purchaseData.quantity, purchaseData.unitPrice, {
                    supplier: purchaseData.supplier,
                    invoiceNumber: purchaseData.invoiceNumber,
                    deliveryDate: purchaseData.deliveryDate,
                    status: purchaseData.status
                });

                elements.purchaseFormSection.classList.add('hidden');
                elements.purchaseForm.reset();

                await loadData();
                showToast('Purchase recorded successfully!', 'success');
            } catch (error) {
                showToast('Error recording purchase: ' + error.message, 'error');
            }
        });

        // Filter events
        elements.statusFilter.addEventListener('change', filterPurchases);
        elements.dateFilter.addEventListener('change', filterPurchases);

        function filterPurchases() {
            const statusFilter = elements.statusFilter.value;
            const dateFilter = elements.dateFilter.value;

            let filteredPurchases = [...allPurchases];

            if (statusFilter) {
                filteredPurchases = filteredPurchases.filter(p => p.status === statusFilter);
            }

            if (dateFilter) {
                filteredPurchases = filteredPurchases.filter(p =>
                    new Date(p.date).toDateString() === new Date(dateFilter).toDateString()
                );
            }

            renderPurchases(filteredPurchases);
        }

        // Global functions
        window.viewPurchaseDetails = (id) => {
            console.log('View purchase details:', id);
        };

        window.markAsDelivered = (id) => {
            if (confirm('Mark this purchase as delivered?')) {
                // Update purchase status logic would go here
                showToast('Purchase marked as delivered!', 'success');
                loadData();
            }
        };

        window.cancelPurchase = (id) => {
            if (confirm('Are you sure you want to cancel this purchase?')) {
                // Cancel purchase logic would go here
                showToast('Purchase cancelled!', 'success');
                loadData();
            }
        };

        window.printPurchaseOrder = (id) => {
            console.log('Print purchase order:', id);
        };

        // Initialize
        await loadData();
    }

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>
</body>
</html>